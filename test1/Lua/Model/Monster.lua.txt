
--------------------------------------------------------------------------------------
--- 怪物
--------------------------------------------------------------------------------------
Monster = class("Monster",CommonCharacter)


-- 加载模型和动画
function Monster:LoadGameObject(name)
    self.Name = name
    self.Model = CSLoadAndInstantiatePrefabGameObject(AssetMonsterPath.."/"..name,AssetMonsterPath.."/"..name)
    --local animator1 = monster1:GetComponent(typeof(CS.UnityEngine.Animator))
    self.Animator =  self.Model:GetComponentInChildren(typeof(CS.UnityEngine.Animator))

    -- 让敌人转过来
    self.Model.transform.localRotation = CS.UnityEngine.Quaternion.Euler(0, 180, 0);
end


-- 是否已经死亡
function Monster:CheckPlayerAlive()
   
end



-- 有没有敌人
function Monster:CheckEnemyNotExist()
    if self.Enable then
        return false
    end
    return true
  
end



-- 敌人是否死亡
function Monster:CheckEnemyLive()
    BattleUIHPSliderPosition(self)
    
    if self.Enemy == nil and #BattleEnemyList == 0 then
        return false  -- 没有活着的敌人
    end
    if self.Enemy ~= nil and self.Enemy.PlayerState == StateDead then
        self:FindNearEnemy()
    end
    
    return true
   
end



-- 往目的地跑过去
function Monster:PlayerRun()

    if self.PlayerState == StateIdle then
        self.PlayerState = StateRun
        self.Animator:SetTrigger("run")
    end

    if self.PlayerState == StateRun then
        self:Log(self.Name .. "跑步ing，距离:" .. self.Distance)
        
        if self.Distance > self.AttackRange then
            -- doTween 来移动角色
            
            local tween = self.Model.transform:DOMove(CS.UnityEngine.Vector3(self.Model.transform.localPosition.x + self.Speed , self.Model.transform.localPosition.y, self.Model.transform.localPosition.z ),BattleAICharacterLoopTimer)
            tween:SetEase(CS.DG.Tweening.Ease.Linear)       -- 设定平均移动方式

        end
    end

    return false

end


-- 怪物普通攻击
function Monster:PlayerAttack()
    self:Log("PlayerAttack   "..self.PlayerState)

    local effect = nil
    if self.PlayerState == StateIdle then
        --EnemyHP = EnemyHP - Damage
        self:Log("敌人被[  普通攻击  ]打了，剩余血量"..self.Enemy.HP)
        --self.Animator:SetTrigger("stoprun")
        self.Animator:SetTrigger("attack")
        self.PlayerState = StateAttack
        --effect =    CSLoadAndInstantiatePrefabGameObject(AssetEffectPath.."/"..self.name,AssetEffectPath.."/"..self.name.."Attack")
        self.Enemy.UnderAttack = true
        self.Enemy.HP = self.Enemy.HP - 11
        BattleUIHPSliderShow(self.Enemy)
        BattleUIDamageNumber(self.Enemy.Model, 11)

        
        return false
    end

    if self.PlayerState == StateAttack then
        self:Log("PlayerState        "..self.PlayerState)
        return self:AnimatorPlayEnd("Attack", true )
    end

end


-- 怪物释放技能
function Monster:PlayerSkillAttack()
    self:PlayerAttack()
    print("Monster: PlayerSkillAttack")

end
--
--
-- 怪物释放技能2
function Monster:PlayerSkillAttack2()
    self:PlayerAttack()
    print(" Monster:  PlayerSkillAttack2")

end



-- 玩家死亡
function Monster:PlayerDead()
    --print("PlayerDead")
    if self.PlayerState ~= StateDead then
        self:Log(self.Name.."播放死亡动画")
        self.Animator:SetTrigger("dead")
        self.PlayerState = StateDead
        MyTimer:after(2, function()        
            CSDestroyGameObject(self.Model)     -- 销毁模型   
            CSDestroyGameObject(self.HPSlider)  -- 销毁血条
            self:BTRootStop()           -- 停止计时器run
            self.BattleBTRoot = nil     -- 清掉ai
            for i in ipairs(BattleEnemyList) do
                if BattleEnemyList[i] == self then
                    table.remove(BattleEnemyList,i)         -- 清理掉列表
                end
            end
            self = nil                  -- 清理掉自身
        end)
        return false
    end

    if self.PlayerState == StateDead then
        --return  self:AnimatorPlayEnd("Death",false)
        
        -- 以后在这里处理复活， 等2秒然后销毁怪物尸体等行为
        self:Log(self.Name.."死了")
    end
end



-- 巡逻
function Monster:EnemyPatrol()
    return true
end


-- 找到附近的敌人
function Monster:FindNearEnemy()
    self.super.FindNearEnemy(self,BattleCharacterList)
    --local dis = GetVector3Distance(BattleCharacterList[1].Model.transform.localPosition, self.Model.transform.localPosition)  -- 距离
    --local lock = BattleCharacterList[1]  -- 锁定
    --for i in ipairs(BattleCharacterList)do
    --    if BattleCharacterList[i].PlayerState ~= StateDead then
    --        local now_dis = GetVector3Distance(BattleCharacterList[i].Model.transform.localPosition, self.Model.transform.localPosition)
    --        if now_dis < dis then
    --            dis = now_dis
    --            lock = BattleCharacterList[i]
    --            --print("距离"..dis.."      锁定"..lock.Name)
    --        end
    --    end
    --end
    --self.Enemy = lock
    ----print(self.Name.."锁定"..lock.Name)
end

